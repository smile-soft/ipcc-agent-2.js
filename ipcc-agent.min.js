!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var o;o="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,o.SmileSoft=e()}}(function(){return function e(o,n,t){function s(r,c){if(!n[r]){if(!o[r]){var l="function"==typeof require&&require;if(!c&&l)return l(r,!0);if(i)return i(r,!0);var a=new Error("Cannot find module '"+r+"'");throw a.code="MODULE_NOT_FOUND",a}var u=n[r]={exports:{}};o[r][0].call(u.exports,function(e){var n=o[r][1][e];return s(n?n:e)},u,u.exports,e,o,n,t)}return n[r].exports}for(var i="function"==typeof require&&require,r=0;r<t.length;r++)s(t[r]);return s}({1:[function(e,o,n){function t(e,o){O.on(e,o)}function s(e,o){O.emit(e,o)}function i(e){var o=1e3*(Math.pow(2,e)-1);return o>3e4&&(o=3e4),Math.random()*o}function r(e,o){5===e?(0!==o.state&&1!==o.state&&6!==o.state&&8!==o.state&&m(),v(o)):7==e&&b(o)}function c(){y=setInterval(function(){w()},C.updateInterval)}function l(e){e.onopen=a,e.onmessage=u,e.onclose=d,e.onerror=f}function a(){console.log("Websocket opened"),s("ready"),w()}function u(e){var o=JSON.parse(e.data),n=o.method;if(console.log("onWebsocketMessage data: ",o),o.error)return s("Error",{module:M,error:o.error});if(o.method){var t=o.params;"setProcess"==n?b(t):"setState"==n&&v(t)}else o.id&&r(o.id,o.result)}function d(){if(console.log("Websocket closed"),C.websockets){var e=i(N);setTimeout(function(){N++,p()},e)}}function f(e){s("Error",{module:M,error:e})}function p(){if(C.webrtc&&(console.log("Initiating WebRTC module"),k.init({sip:C.sip,audioRemote:C.audioRemote})),C.websockets){if(!window.WebSocket)return console.log("WebSocket is not supported. Please update your browser."),console.log("Fallback to XMLHttpRequest"),C.websockets=!1,p();console.log("Switched to Websockets"),void 0!==y&&clearInterval(y),S=new WebSocket(("https"===P?"wss":"ws")+"://"+C.server+"/","json.api.smile-soft.com"),l(S)}else void 0!==S&&S.close(),console.log("Switched to XMLHttpRequest"),c(),s("ready")}function g(e,o,n){var t,i,r,c={},l=null;c.method=e,o&&(c.params=o),"number"==typeof n&&(c.id=n),c=JSON.stringify(c),C.websockets?S.send(c):(t=new XMLHttpRequest,t.open("POST",P+"://"+C.server+"/",!0),r=setTimeout(function(){t.abort()},3e4),t.onreadystatechange=function(){4==t.readyState&&(clearTimeout(r),t.response&&(i=JSON.parse(t.response),i.error&&(l=i.error,s("Error",{module:M,error:l})),n&&n(i.result)))},t.setRequestHeader("Content-Type","application/json; charset=UTF-8"),t.send(c))}function m(){g("getProcess",null,C.websockets?7:b)}function w(){g("getState",null,C.websockets?5:v)}function v(e){s("statechange",e)}function b(e){s("processchange",e)}function h(e){return e&&(C=R.deepExtend(C,e)),T?console.warn("Module "+M+" already initiated, do nothing"):(console.log("Initiating "+C.moduleName+" module with options: ",C),p(),T=!0,x)}var y,S,x,k=e("./webrtc"),O=e("./events"),R=e("./utils"),C=e("./options"),M=C.moduleName,P=-1!==window.location.protocol.indexOf("https")?"https":"http",N=1,T=!1,E="";x={process:{},state:null,substate:null,on:t,emit:s,call:function(e){C.webrtc?k.audiocall(e):g("initCall",{number:e})},answer:function(){g("answerCall")},hold:function(){g("pressHold")},idle:function(){1===x.state||6===x.state?g("setPauseState",{state:0}):console.log("Not in WRAP or PAUSE, do nothing.")},conference:function(){g("pressConference")},drop:function(){C.webrtc?k.terminate():g("dropCall")},close:function(e,o){return E="",e||(E+="processid is not defined\n"),o||(E+="exitcode is not defined\n"),""!==E?console.error("Can't close process:\n"+E):void g("closeProcess",{processid:e,exitcode:o})},pause:function(e,o){g("setPauseState",{state:e,comment:o||""})}},t("statechange",function(e){x.state=e.state,x.substate=e.substate}),t("processchange",function(e){x.process=e}),o.exports=h},{"./events":2,"./options":4,"./utils":5,"./webrtc":6}],2:[function(e,o,n){var t={},s=t.hasOwnProperty;o.exports={on:function(e,o){s.call(t,e)||(t[e]=[]);var n=t[e].push(o)-1;return{off:function(){delete t[e][n]}}},emit:function(e,o){s.call(t,e)&&t[e].forEach(function(e){e(void 0!==o?o:{})})}}},{}],3:[function(e,o,n){(function(n){var t=n.SmileSoft||{},s=e("./options"),i=e("./api");t[s.moduleName]=i,o.exports=t}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./api":1,"./options":4}],4:[function(e,o,n){(function(e){o.exports={moduleName:"Agent",server:e.location.host,updateInterval:1e3,websockets:!0,webrtc:!0,sip:{realm:e.location.host,ws_servers:"wss://"+e.location.host,register:!0},audioRemote:null}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],5:[function(e,o,n){function t(e,o){var n=Object.create(e);return Object.keys(o).map(function(e){e in n&&(n[e]=o[e])}),n}function s(e,o){for(var n in o)o[n]&&o[n].constructor&&o[n].constructor===Object?(e[n]=e[n]||{},arguments.callee(e[n],o[n])):e[n]=o[n];return e}o.exports={extendObj:t,deepExtend:s}},{}],6:[function(e,o,n){(function(n){function t(){u.on("connected",function(e){console.log("sip connected event: ",e)}),u.on("disconnected",function(e){console.log("sip disconnected event: ",e)}),u.on("newMessage",function(e){console.log("sip newMessage event: ",e)}),u.on("newRTCSession",function(e){console.log("sip newRTCSession event: ",e),d=e.session}),u.on("registered",function(e){console.log("sip registered event: ",e)}),u.on("unregistered",function(e){console.log("sip unregistered event: ",e)}),u.on("registrationFailed",function(e){console.log("sip registrationFailed event: ",e)}),f={progress:function(e){console.log("call progress event: ",e),p.emit("call.progress",e)},failed:function(e){console.log("call failed event:",e),p.emit("call.failed",e)},ended:function(e){console.log("call ended event: ",e),p.emit("call.ended",e)},confirmed:function(e){console.log("call confirmed event: ",e),p.emit("call.confirmed",e)},addstream:function(e){console.log("call addstream event: ",e);var o=e.stream;a.audioRemote=g.rtcninja.attachMediaStream(a.audioRemote,o)}}}function s(e){d=u.call(e,{eventHandlers:f,mediaConstraints:{audio:!0,video:!1}})}function i(){u.terminateSessions()}function r(){console.log("answer: ",u),d.answer()}function c(){console.log("hold: ",d.isOnHold()),d&&d.isOnHold().local?d.unhold():d.hold()}function l(e){return a=e,u=new g.UA(a.sip),t(),u.start(),u}var a,u,d,f,p=e("./events"),g=n.JsSIP;o.exports={lib:g,init:l,audiocall:s,terminate:i,answer:r,hold:c}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./events":2}]},{},[3])(3)});