!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).SmileSoft=e()}}(function(){return function i(r,c,a){function l(n,e){if(!c[n]){if(!r[n]){var o="function"==typeof require&&require;if(!e&&o)return o(n,!0);if(d)return d(n,!0);var t=new Error("Cannot find module '"+n+"'");throw t.code="MODULE_NOT_FOUND",t}var s=c[n]={exports:{}};r[n][0].call(s.exports,function(e){return l(r[n][1][e]||e)},s,s.exports,i,r,c,a)}return c[n].exports}for(var d="function"==typeof require&&require,e=0;e<a.length;e++)l(a[e]);return l}({1:[function(e,n,o){var t,a,s,i=e("./webrtc"),r=e("./events"),c=e("./utils"),l=e("./options"),d=l.moduleName,u=-1!==window.location.protocol.indexOf("https")?"https":"http",f=1,p=!1,w="";function g(e,n){r.on(e,n)}function m(e,n){r.emit(e,n)}function b(e,n){5===e?(0!==n.state&&1!==n.state&&6!==n.state&&8!==n.state&&k("getProcess",null,l.websockets?7:O),R(n)):7==e&&O(n)}function v(){console.log("Websocket opened"),m("ready"),x()}function h(e){var n=JSON.parse(e.data),o=n.method;if(console.log("onWebsocketMessage data: ",n),n.error)return m("Error",{module:d,error:n.error});if(n.method){var t=n.params;"setProcess"==o?O(t):"setState"==o&&R(t)}else n.id&&b(n.id,n.result)}function y(){if(console.log("Websocket closed"),l.websockets){var e=(n=f,3e4<(o=1e3*(Math.pow(2,n)-1))&&(o=3e4),Math.random()*o);setTimeout(function(){f++,C()},e)}var n,o}function S(e){m("Error",{module:d,error:e})}function C(){if(l.webrtc&&i.init({sip:l.sip}),l.websockets){if(!window.WebSocket)return console.log("WebSocket is not supported. Please update your browser."),console.log("Fallback to XMLHttpRequest"),l.websockets=!1,C();console.log("Switched to Websockets"),void 0!==t&&clearInterval(t),a=new WebSocket(("https"===u?"wss":"ws")+"://"+l.server+"/","json.api.smile-soft.com"),(e=a).onopen=v,e.onmessage=h,e.onclose=y,e.onerror=S}else void 0!==a&&a.close(),console.log("Switched to XMLHttpRequest"),t=setInterval(function(){x()},l.updateInterval),m("ready");var e}function k(e,n,o){var t,s,i,r={},c=null;r.method=e,n&&(r.params=n),"number"==typeof o&&(r.id=o),r=JSON.stringify(r),l.websockets?a.send(r):((t=new XMLHttpRequest).open("POST",u+"://"+l.server+"/",!0),i=setTimeout(function(){t.abort()},3e4),t.onreadystatechange=function(){4==t.readyState&&(clearTimeout(i),t.response&&((s=JSON.parse(t.response)).error&&(c=s.error,m("Error",{module:d,error:c})),o&&o(s.result)))},t.setRequestHeader("Content-Type","application/json; charset=UTF-8"),t.send(r))}function x(){k("getState",null,l.websockets?5:R)}function R(e){m("statechange",e)}function O(e){m("processchange",e)}s={process:{},state:null,substate:null,on:g,emit:m,call:function(e){l.webrtc?i.audiocall(e):k("initCall",{number:e})},answer:function(){l.webrtc?i.answer():k("answerCall")},hold:function(){k("pressHold")},idle:function(){1===s.state||6===s.state?k("setPauseState",{state:0}):console.log("Not in WRAP or PAUSE, do nothing.")},conference:function(){k("pressConference")},drop:function(){l.webrtc?i.terminate():k("dropCall")},close:function(e,n){if(w="",e||(w+="processid is not defined\n"),n||(w+="exitcode is not defined\n"),""!==w)return console.error("Can't close process:\n"+w);k("closeProcess",{processid:e,exitcode:n})},pause:function(e,n){k("setPauseState",{state:e,comment:n||""})}},g("statechange",function(e){s.state=e.state,s.substate=e.substate}),g("processchange",function(e){s.process=e}),n.exports=function(e){return e&&(l=c.deepExtend(l,e)),p?console.warn("Module "+d+" already initiated, do nothing"):(console.log("Initiating "+l.moduleName+" module with options: ",l),C(),p=!0,s)}},{"./events":2,"./options":4,"./utils":5,"./webrtc":6}],2:[function(e,n,o){var t={},s=t.hasOwnProperty;n.exports={on:function(e,n){s.call(t,e)||(t[e]=[]);var o=t[e].push(n)-1;return{off:function(){delete t[e][o]}}},emit:function(e,n){s.call(t,e)&&t[e].forEach(function(e){e(void 0!==n?n:{})})}}},{}],3:[function(s,i,e){(function(e){var n=e.SmileSoft||{},o=s("./options"),t=s("./api");n[o.moduleName]=t,i.exports=n}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./api":1,"./options":4}],4:[function(e,n,o){(function(e){n.exports={moduleName:"Agent",server:e.location.host,updateInterval:1e3,websockets:!0,webrtc:!0,sip:{realm:e.location.host,ws_servers:"wss://"+e.location.host,register:!0},audioRemote:null}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],5:[function(e,n,o){n.exports={extendObj:function(e,n){var o=Object.create(e);return Object.keys(n).map(function(e){e in o&&(o[e]=n[e])}),o},deepExtend:function(e,n){for(var o in n)n[o]&&n[o].constructor&&n[o].constructor===Object?(e[o]=e[o]||{},arguments.callee(e[o],n[o])):e[o]=n[o];return e}}},{}],6:[function(e,n,o){(function(s){var i,r,c,a=e("./utils"),l=e("./events"),d={};n.exports={init:function(e){var n,o,t=s.JsSIP;console.log("JsSIP: ",s,t),(d=a.deepExtend(d,e)).audioRemote=((o=document.createElement("audio")).setAttribute("autoplay","autoplay"),document.body.appendChild(o),o),n=new t.WebSocketInterface(d.sip.ws_servers),d.sip.sockets=[n],void 0===d.sip.register&&(d.sip.register=!1),console.log("Initiating WebRTC module:",d),(i=new t.UA(d.sip)).on("connected",function(e){console.log("sip connected event: ",e)}),i.on("disconnected",function(e){console.log("sip disconnected event: ",e)}),i.on("newMessage",function(e){console.log("sip newMessage event: ",e)}),i.on("newRTCSession",function(e){console.log("sip newRTCSession event: ",e),l.emit("webrtc/newRTCSession",e),r=e.session}),i.on("registered",function(e){console.log("sip registered event: ",e)}),i.on("unregistered",function(e){console.log("sip unregistered event: ",e)}),i.on("registrationFailed",function(e){console.log("sip registrationFailed event: ",e)}),c={progress:function(e){console.log("call progress event: ",e),l.emit("webrtc/progress",e)},failed:function(e){console.log("call failed event:",e),l.emit("webrtc/failed",e)},ended:function(e){console.log("call ended event: ",e),l.emit("webrtc/ended",e)},confirmed:function(e){console.log("call confirmed event: ",e),l.emit("webrtc/confirmed",e)},sdp:function(e){console.log("sdp event: ",e)}},i.start()},unregister:function(){i.stop()},audiocall:function(e){(r=i.call(e,{eventHandlers:c,mediaConstraints:{audio:!0,video:!1}})).connection.addEventListener("track",function(e){l.emit("webrtc/addstream",e),d.audioRemote.srcObject!==e.streams[0]&&(d.audioRemote.srcObject=e.streams[0])})},terminate:function(){r.terminate({status_code:200})},answer:function(){console.log("answer: ",i),r.answer()},hold:function(){console.log("hold: ",r.isOnHold()),r&&r.isOnHold().local?r.unhold():r.hold()},isInProgress:function(){return r.isInProgress()},isEstablished:function(){return r.isEstablished()},isEnded:function(){return r.isEnded()},isSupported:function(){var e=window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection,n=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.msGetUserMedia||navigator.mozGetUserMedia||navigator.mediaDevices.getUserMedia,o=window.mozRTCIceCandidate||window.RTCIceCandidate;return!!e&&!!n&&!!o}}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./events":2,"./utils":5}]},{},[3])(3)});